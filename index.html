<script>
    const LIFF_ID = "https://liff.line.me/2006949127-qlKbVbKb"; // æ›¿æ›ç‚ºä½ çš„ LIFF ID
    const GAS_URL = "https://script.google.com/macros/s/AKfycbx2o3RKPBImJFbtV5sgdm7hEtC7FHIkv8nmX4oa7A9BN9VgzPydp4fMiNsN8VMyUd0pjg/exec"; // æ›¿æ›æˆä½ çš„ Google Apps Script URL

    async function initLIFF() {
        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
            liff.login();
        } else {
            const profile = await liff.getProfile();
            console.log("LIFF å·²ç²å–ç”¨æˆ¶:", profile);
            document.getElementById("user-info").innerText = `æ­¡è¿, ${profile.displayName} ğŸŒŸ`;
            loadUserData(profile.userId);
        }
    }

    async function loadUserData(userId) {
        console.log("æ­£åœ¨è«‹æ±‚è©¦ç®—è¡¨æ•¸æ“š, ç”¨æˆ¶ ID:", userId);
        try {
            const response = await fetch(`${GAS_URL}?action=getUserData&userId=${userId}`);
            const result = await response.json();
            console.log("å¾è©¦ç®—è¡¨ç²å–çš„æ•¸æ“š:", result);
            
            if (result.exists) {
                document.getElementById("user-info").innerText = `æ­¡è¿, ${result.displayName} ğŸŒŸ`;
                document.getElementById("stats").innerHTML = `
                    ğŸ† ç¸½ç°½åˆ°æ¬¡æ•¸ï¼š${result.totalSignIn} æ¬¡<br>
                    ğŸ”¥ é€£çºŒç°½åˆ°ï¼š${result.consecutiveSignIn} å¤©
                `;
                document.getElementById("sign-in-btn").disabled = false;
                document.getElementById("sign-in-btn").addEventListener("click", () => signIn(userId, result.displayName));
            } else {
                document.getElementById("user-info").innerText = "è«‹å…ˆåœ¨ LINE è¼¸å…¥ã€åŠ å…¥éŠæˆ²ã€";
                document.getElementById("stats").innerText = "";
            }
        } catch (error) {
            console.error("ç„¡æ³•è¼‰å…¥ç”¨æˆ¶è³‡æ–™:", error);
            document.getElementById("stats").innerText = "âŒ ç„¡æ³•è¼‰å…¥æ‚¨çš„æ•¸æ“šï¼Œè«‹ç¨å¾Œå†è©¦ã€‚";
        }
    }

    async function signIn(userId, displayName) {
        try {
            const response = await fetch(GAS_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ userId, displayName })
            });
            const result = await response.json();
            alert(result.message);
            document.getElementById("sign-in-btn").disabled = true;
            loadUserData(userId); // é‡æ–°è¼‰å…¥æ•¸æ“š
        } catch (error) {
            console.error("ç°½åˆ°éŒ¯èª¤:", error);
        }
    }

    initLIFF();
</script>
